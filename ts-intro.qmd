---
title: "TS-intro"
format: html
editor_options: 
  chunk_output_type: console
---

## Пример формулы в техе

Вспомним теорему Пифагора :)
$$
c = \sqrt{a^2 + b^2}
$$


## Маленькое введение в ETS-модель


$y_t$ — наблюдаемый временной ряд

Идейно в ряду есть случайность, сезонная составляющая и тренд.

$\ell_t$ — ряд, очищенный от случайности и от сезонности. 

$b_t$ — текущая скорость роста ряда

$s_t$ — сезонная прибавка

**Если бы не было случайности**...

$$
\begin{cases}
s_t = s_{t-12} \\
b_t = b_{t-1} \\
\ell_t = \ell_{t-1} + b_{t-1} \\
y_t = \ell_{t-1} + b_{t-1} + s_{t-12}
\end{cases}
$$

**Добавим случайность!**...

$u_t$ — случайность в момент $t$

$$
\begin{cases}
u_t \sim N(0; \sigma^2) \\
s_t = s_{t-12} + \gamma u_t\\
b_t = b_{t-1} + \beta u_t \\
\ell_t = \ell_{t-1} + b_{t-1} + \alpha u_t \\
y_t = \ell_{t-1} + b_{t-1} + s_{t-12} + u_t
\end{cases}
$$

Что оценивается?

Данные: $y_1$, $y_2$, ..., $y_T$

Неизвестные параметры: $\alpha$, $\beta$, $\gamma$, $\sigma^2$, $\ell_0$, $b_0$, $s_0$, $s_{-1}$, $s_{-2}$, ..., $s_{-11}$ с ограничением $s_0 + s_{-1} + ... + s_{-11}=0$.

Что почитать? 

[Rob Hyndman, Forecasting principles and practice](https://otexts.com/fpp3/)

## Метод максимального правдоподобия:

Выберем такие оценки неизвестных параметров, чтобы 
**максимизировать вероятность** имеющегося набора данных.

После решения задачи максимизации: $\hat\alpha$, $\hat\beta$, $\hat\gamma$, ....

## Вторая часть Мерлезонского балета :)

[Источник данных](https://fedstat.ru/indicator/33553)

```{r}
url_orig = 'https://github.com/bdemeshev/webinar_eusp_forecasting_r_2021_03_13/raw/main/original_data.xls'
```

Встаем на плечи гигантов и подключаем пакеты :)
```{r}
library(rio) # импорт-экспорт данных
library(tidyverse) # визуализация + обработка данных 
library(fpp3) # пачка пакетов по времен рядам
```

Смотрим на наш набор данных!
```{r}
d = import('original_data.csv')
colnames(d) = d[3, ]
d1 = d[-(1:3), ]
d2 = d1[, -2]
colnames(d2)[1:2] = c('region', 'period')

# export(d2, 'd2.csv')
# d2 = import('d2.csv')

unique(d2$region)
d3 = filter(d2, !str_detect(period, '-'))
d4 = separate(d3, period, c('percode', 'month'), sep = ' ')

d5 = pivot_longer(d4, cols=`2006`:`2020`,
                  names_to = 'year',
                  values_to = 'marriage')
d6 = separate(d5, region, c('regcode', 'region'), 
              sep = ' ', extra = 'merge')
d7 = select(d6, -percode)

# export(d7, 'd7.csv')
# d7 = import('d7.csv')

```










